@page "/"
@using Newtonsoft.Json
@using TechnologyCharacterGenerator.Child.Common.BusinessLogic

@inject HttpClient HttpClient
@inject ITechnologyCharacterCreator TechnologyCharacterGenerator

@inject IUserViewModelUpdateReceiver UserViewModelUpdateReceiver
@inject IApplicationNameProvider ApplicationNameProvider
@inject IStatusReportSender StatusReportSender

<h1>Technology Character Generator - @ApplicationName</h1>

@*//TODO ReadOnly should be controlled by whether the app is hosted in the parent app or not.*@
<UserForm Id="childUserForm" IsCollapsed="true" bind-Model="@UserViewModel" ModelSubmittedAsync="@GeneratePersonaAsync" ReadOnly="@true" />

@if (null != TechnologyCharacterViewModel)
{
    <TechnologyCharacter Model="@TechnologyCharacterViewModel" />
}

@functions {
    UserViewModel UserViewModel { get; set; } = new UserViewModel();

    TechnologyCharacterViewModel TechnologyCharacterViewModel { get; set; }

    string ApplicationName { get; set; }

    async Task GeneratePersonaAsync(UserViewModel userViewModel)
    {
        TechnologyCharacterViewModel = await Task.Run(() => TechnologyCharacterGenerator.GenerateTechnologyCharacter(userViewModel));

        this.StateHasChanged();
    }

    protected override async Task OnInitAsync()
    {
        ApplicationName = await ApplicationNameProvider.GetApplicationNameAsync();

        await JSRuntime.Current.InvokeAsync<object>(
            "userViewModelUpdater.init", new DotNetObjectRef(UserViewModelUpdateReceiver));

        UserViewModelUpdateReceiver.UserViewModelUpdated += model =>
        {
            UserViewModel = model;

            this.StateHasChanged();
        };

        UserViewModelUpdateReceiver.UserViewModelSubmitted += async model => await GeneratePersonaAsync(model);

        await StatusReportSender.SendStatusReportAsync(ChildApplicationStatuses.ApplicationLoadCompleted);
    }
}